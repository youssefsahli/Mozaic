<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mozaic</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      /* ── CSS Variables — Compact IDE Palette ── */
      :root {
        --bg:         #050A14;
        --surface:    #0A1222;
        --surface-2:  #0D1A30;
        --surface-3:  #132240;
        --border:     #16243E;
        --border-hi:  #1E3358;
        --text:       #A0B6D4;
        --text-dim:   #5A7899;
        --accent:     #00F0FF;
        --accent-bg:  rgba(0,240,255,.12);
        --accent-hover: #33F4FF;
        --danger:     #FF4D6A;
        --success:    #00E676;
        --warning:    #FFD740;
        --info:       #40C4FF;
        --radius:     3px;
        --radius-lg:  5px;
        --font-mono:  'Fira Code','Consolas',ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;
        --header-h:   32px;
        --tab-h:      26px;
        --sidebar-w:  180px;
        --ease:       150ms cubic-bezier(0.4,0,0.2,1);
        --shadow-sm:  0 1px 2px rgba(0,0,0,.4);
        --shadow-md:  0 2px 8px rgba(0,0,0,.5);
      }

      /* ── Reset ────────────────────────────────── */
      *, *::before, *::after { margin:0; padding:0; box-sizing:border-box }

      body {
        background: var(--bg);
        color: var(--text);
        font: 11px/1.4 var(--font-mono);
        height: 100dvh;
        overflow: hidden;
      }

      /* ── App Shell — 5-column IDE grid (with splitters) ── */
      #mozaic-app {
        display: grid;
        height: 100dvh;
        width: 100vw;
        overflow: hidden;
        grid-template-rows: var(--header-h) 1fr 20px;
        /* Sidebar | Split | Center | Split | Panel */
        grid-template-columns: auto auto 1fr auto auto;
        grid-template-areas:
          "header  header  header   header   header"
          "sidebar lsplit  center   rsplit   panel"
          "status  status  status   status   status";
      }

      /* ── Header — compact 32px toolbar ──────── */
      #mozaic-header {
        grid-area: header;
        height: var(--header-h);
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 0 6px;
      }
      #header-brand {
        display: flex;
        align-items: center;
        gap: 5px;
        color: var(--accent);
        font-weight: bold;
        white-space: nowrap;
        flex-shrink: 0;
        margin-right: 4px;
      }
      #header-logo { font-size: 13px }
      #header-title { font-size: 10px; text-transform: uppercase; letter-spacing: .08em }
      #header-divider {
        width: 1px;
        height: 16px;
        background: var(--border-hi);
        flex-shrink: 0;
        margin: 0 2px;
      }
      #header-actions {
        display: flex;
        align-items: center;
        gap: 2px;
        flex: 1;
        min-width: 0;
      }
      .header-sep {
        width: 1px;
        height: 14px;
        background: var(--border-hi);
        flex-shrink: 0;
        margin: 0 2px;
      }

      /* ── Modal Overlay ────────────────────── */
      #modal-overlay {
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(2px);
        z-index: 1000;
        display: none;
        align-items: center; justify-content: center;
      }
      #modal-overlay.is-visible { display: flex }
      .modal-window {
        background: var(--surface);
        border: 1px solid var(--border-hi);
        box-shadow: var(--shadow-md);
        border-radius: var(--radius-lg);
        min-width: 300px; max-width: 90vw;
        display: flex; flex-direction: column;
        animation: modal-pop 150ms ease-out;
      }
      @keyframes modal-pop { from { transform: scale(0.95); opacity: 0 } to { transform: scale(1); opacity: 1 } }
      .modal-header {
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        display: flex; align-items: center; justify-content: space-between;
        background: var(--surface-2);
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      }
      .modal-title { font-weight: bold; color: var(--text-bright); font-size: 12px }
      .modal-close {
        background: transparent !important; border: none !important;
        color: var(--text-dim) !important; font-size: 16px !important;
        padding: 0 !important; width: 20px; height: 20px;
        display: flex; align-items: center; justify-content: center;
      }
      .modal-close:hover { color: var(--text) !important }
      .modal-body { padding: 16px; display: flex; flex-direction: column; gap: 12px }
      .modal-row { display: flex; align-items: center; gap: 8px }
      .modal-row label { flex: 1; color: var(--text-dim) }
      .modal-row input, .modal-row select {
        background: var(--bg); border: 1px solid var(--border);
        color: var(--text); padding: 4px 8px; border-radius: var(--radius);
        flex: 2; min-width: 0;
      }
      .modal-footer {
        padding: 8px 12px;
        border-top: 1px solid var(--border);
        display: flex; justify-content: flex-end; gap: 8px;
        background: var(--surface-2);
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      }
      .modal-btn-primary {
        background: var(--accent-bg) !important;
        border-color: var(--accent) !important;
        color: var(--accent) !important;
      }
      .modal-btn-primary:hover { background: var(--accent) !important; color: #000 !important }

      /* ── Left Sidebar (collapsible file tree) ── */
      #left-sidebar {
        grid-area: sidebar;
        width: var(--sidebar-w);
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: width var(--ease), min-width var(--ease);
        min-width: var(--sidebar-w);
      }
      #left-sidebar.is-collapsed {
        width: 0;
        min-width: 0;
        border-right: none;
      }
      #left-sidebar.is-collapsed > * { display: none }

      /* File tree panel inside sidebar */
      #file-tree-panel {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }
      #file-tree-header {
        display: flex;
        align-items: center;
        gap: 3px;
        padding: 3px 6px;
        background: var(--surface-2);
        border-bottom: 1px solid var(--border);
        user-select: none;
        flex-shrink: 0;
        min-height: 24px;
      }
      #file-tree-header:hover { background: var(--surface-3) }
      #file-tree-title {
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: .06em;
        color: var(--text-dim);
        cursor: pointer;
        flex: 1;
      }
      #file-tree-toggle {
        font-size: 9px;
        color: var(--text-dim);
        transition: transform 120ms;
        cursor: pointer;
      }
      #file-tree-panel.is-collapsed #file-tree-toggle { transform: rotate(-90deg) }
      #file-tree-panel.is-collapsed #file-tree-container { display: none }
      #file-tree-container {
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
        padding: 1px 0;
      }

      /* ── Center — Game canvas (largest area) ── */
      #canvas-area {
        grid-area: center;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: var(--bg);
        padding: 4px;
        position: relative;
        min-width: 100px;
      }
      #mozaic-canvas {
        max-width: 100%;
        max-height: 100%;
      }

      /* ── Compiler Console overlay ──────────── */
      #compiler-console {
        position: absolute;
        bottom: 0; left: 0; right: 0;
        max-height: 50%;
        overflow-y: auto;
        background: rgba(5, 10, 20, 0.94);
        font: 11px/1.5 var(--font-mono);
        color: #ccc;
        padding: 4px 8px;
        z-index: 10;
        display: none;
      }
      #compiler-console.is-visible { display: block }
      #compiler-console .cc-line { white-space: pre-wrap }
      #compiler-console .cc-info  { color: #b0b0b0 }
      #compiler-console .cc-success { color: #6a9955 }
      #compiler-console .cc-error { color: #d16969 }

      /* ── Input Debug overlay ──────────────── */
      #input-debug {
        position: absolute;
        top: 6px; right: 6px;
        font: 10px var(--font-mono);
        color: var(--accent);
        background: rgba(0,0,0,.7);
        padding: 2px 6px;
        border-radius: 3px;
        pointer-events: none;
        white-space: pre-wrap;
        z-index: 100;
        display: none;
      }
      #input-debug.is-visible { display: block }

      /* ── Split handle (between center & right) ── */
      #split-handle {
        grid-area: rsplit;
        width: 6px; /* Wider hit area for easier grabbing */
        cursor: col-resize;
        position: relative;
        z-index: 10;
        transition: background 120ms;
        display: flex;
        justify-content: center;
      }
      #split-handle::before, #left-split-handle::before {
        content: '';
        width: 1px;
        height: 100%;
        background: var(--border);
        transition: all 150ms ease;
      }
      #split-handle:hover::before,
      #split-handle.is-dragging::before,
      #left-split-handle:hover::before,
      #left-split-handle.is-dragging::before {
        background: var(--accent);
        box-shadow: 0 0 6px var(--accent);
        width: 2px;
      }

      /* ── Left Split handle ───────────────────── */
      #left-split-handle {
        grid-area: lsplit;
        width: 6px;
        cursor: col-resize;
        position: relative;
        z-index: 10;
        transition: background 120ms;
        display: flex;
        justify-content: center;
      }

      /* ── Right panel — tabbed editor ─────────── */
      #side-panel {
        grid-area: panel;
        width: 340px;
        min-width: 0;
        display: flex;
        flex-direction: column;
        background: var(--surface);
        /* Border handled by split-handle */
        /* border-left: 1px solid var(--border); */
        overflow: hidden;
        transition: width var(--ease), min-width var(--ease);
      }
      #side-panel.is-resizing { transition: none !important }
      #side-panel.is-collapsed {
        width: 0;
        min-width: 0;
        border-left: none;
      }
      #side-panel.is-collapsed > * { display: none }

      /* ── Workspace wrapper (center + split + panel) ── */
      #mozaic-workspace {
        display: contents;
      }

      /* ── Tab bar — compact ──────────────────── */
      #tab-bar {
        display: flex;
        align-items: stretch;
        height: var(--tab-h);
        min-height: var(--tab-h);
        background: var(--surface-2);
        border-bottom: 1px solid var(--border);
        gap: 0;
        flex-shrink: 0;
      }
      .tab-btn {
        flex: 1;
        padding: 0 6px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-dim);
        font: 10px/1 var(--font-mono);
        text-transform: uppercase;
        letter-spacing: .05em;
        cursor: pointer;
        transition: color var(--ease), border-color var(--ease), background var(--ease);
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 3px;
      }
      .tab-btn:hover {
        color: var(--text);
        background: rgba(255,255,255,.03);
      }
      .tab-btn.is-active {
        color: var(--accent) !important;
        border-bottom-color: var(--accent) !important;
        background: var(--accent-bg) !important;
      }
      .tab-btn[hidden] { display: none }
      .tab-icon {
        width: 12px; height: 12px;
        fill: none; stroke: currentColor;
        stroke-width: 1.4; stroke-linecap: round; stroke-linejoin: round;
        flex-shrink: 0;
      }

      /* ── Tab content ───────────────────────── */
      #tab-content {
        flex: 1;
        overflow: hidden;
        position: relative;
      }
      .tab-pane {
        position: absolute;
        inset: 0;
        display: none;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 4px;
        gap: 4px;
      }
      .tab-pane.is-active { display: flex }

      /* ── Section label ────────────────────── */
      .section-label {
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: .06em;
        color: var(--text-dim);
        margin-top: 2px;
      }

      /* ── Shared button — compact ──────────── */
      button:not(.tab-btn):not(.pane-toggle-btn), .btn {
        font: inherit;
        padding: 2px 6px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: var(--radius);
        cursor: pointer;
        transition: background 80ms, border-color 80ms;
        white-space: nowrap;
        line-height: 1.4;
        font-size: 10px;
      }
      button:not(.tab-btn):not(.pane-toggle-btn):hover  { background: var(--surface-3); border-color: var(--border-hi) }
      button:not(.tab-btn):not(.pane-toggle-btn):active { background: var(--surface-2) }
      button:not(.tab-btn):not(.pane-toggle-btn):disabled { opacity: .35; cursor: default; pointer-events: none }
      .is-active:not(.tab-btn):not(.pane-toggle-btn) {
        background: var(--accent-bg) !important;
        border-color: var(--accent) !important;
        color: var(--accent) !important;
      }

      /* ── Button row ───────────────────────── */
      .btn-row { display: flex; gap: 3px; flex-wrap: wrap }

      /* ── Script editor ────────────────────── */
      #msc-editor-wrap {
        position: relative;
        flex: 1;
        min-height: 100px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
      }
      #msc-highlight, #msc-editor {
        position: absolute; top: 0; right: 0; bottom: 0; left: 32px;
        margin: 0; border: 0;
        padding: 4px 6px;
        font: 11px/1.45 var(--font-mono);
        white-space: pre; overflow: auto;
      }
      #msc-highlight { pointer-events: none; color: #ddd }
      #msc-editor {
        resize: none;
        background: transparent;
        color: transparent;
        caret-color: #eee;
      }
      #msc-editor:focus {
        outline: none;
        box-shadow: inset 0 0 0 1px var(--accent);
      }
      #msc-editor::selection { background: rgba(0,240,255,.25) }
      #msc-highlight::selection, #msc-highlight *::selection { background: transparent }
      #msc-status {
        min-height: 12px;
        font-size: 10px;
        color: var(--text-dim);
        flex-shrink: 0;
      }

      /* ── Pixel editor controls ────────────── */
      #pixel-controls { display: flex; flex-direction: column; gap: 3px; flex-shrink: 0 }
      .pixel-row { display: flex; align-items: center; gap: 3px; flex-wrap: wrap }
      .pixel-row input[type=number] {
        width: 40px; padding: 1px 3px;
        background: var(--bg); border: 1px solid var(--border);
        color: var(--text); border-radius: var(--radius); font: inherit;
      }
      .pixel-row input[type=color] {
        width: 20px; height: 20px; padding: 0;
        border: 1px solid var(--border); border-radius: var(--radius);
        background: none; cursor: pointer;
      }
      .pixel-row label { color: var(--text-dim); cursor: pointer; user-select: none; font-size: 10px }

      /* ── Pixel toolbox ────────────────────── */
      #pixel-workspace {
        display: flex;
        gap: 3px;
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }
      #pixel-toolbox {
        display: flex;
        flex-direction: column;
        gap: 1px;
        flex-shrink: 0;
        padding: 3px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
      }
      .tool-btn {
        width: 24px !important; height: 24px !important; min-width: 24px !important;
        padding: 0 !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        line-height: 1;
        border-radius: var(--radius) !important;
        transition: all 80ms;
      }
      .tool-btn:hover {
        background: var(--surface-3) !important;
        border-color: var(--border-hi) !important;
      }
      .tool-btn.is-active {
        box-shadow: 0 0 0 1px var(--accent);
        background: var(--accent-bg) !important;
        border-color: var(--accent) !important;
      }
      .tool-btn svg {
        width: 14px; height: 14px;
        fill: none; stroke: currentColor;
        stroke-width: 1.3; stroke-linecap: round; stroke-linejoin: round;
      }
      .tool-btn.is-active svg { stroke: var(--accent) }
      .toolbox-sep {
        width: 16px; height: 1px;
        background: var(--border);
        margin: 2px auto;
        opacity: .5;
      }

      /* ── Palette ──────────────────────────── */
      #palette-swatches {
        display: flex; gap: 2px; flex-wrap: wrap;
        padding: 3px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        min-height: 22px;
      }
      .palette-swatch {
        width: 16px; height: 16px;
        border: 1px solid rgba(255,255,255,.08); border-radius: 2px;
        cursor: pointer; transition: border-color 80ms, transform 80ms;
        position: relative;
        overflow: visible;
      }
      .palette-swatch:hover { border-color: var(--text-dim); transform: scale(1.15); z-index: 2 }
      .palette-swatch.is-active {
        border-color: var(--accent);
        box-shadow: 0 0 0 1.5px var(--accent);
        transform: scale(1.15); z-index: 2;
      }
      .palette-swatch.is-locked::after {
        content: ''; position: absolute; inset: 0;
        border: 1px solid rgba(255,255,255,.5);
        border-radius: 1px; pointer-events: none;
      }
      .palette-swatch .lock-indicator {
        position: absolute; bottom: -2px; right: -2px;
        font-size: 6px; line-height: 1; pointer-events: none;
      }
      .palette-swatch .msc-indicator {
        position: absolute; top: -2px; right: -2px;
        width: 3px; height: 3px; border-radius: 50%;
        background: var(--accent); pointer-events: none;
      }
      .palette-swatch .swatch-name {
        position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
        font-size: 7px; white-space: nowrap; pointer-events: none;
        color: var(--text); background: var(--surface-3);
        padding: 1px 2px; border-radius: 2px;
        opacity: 0; transition: opacity 80ms;
        z-index: 10;
      }
      .palette-swatch:hover .swatch-name { opacity: 1 }
      #palette-preset-select {
        padding: 1px 3px; font: inherit; font-size: 10px;
        background: var(--surface-2); border: 1px solid var(--border);
        color: var(--text); border-radius: var(--radius); cursor: pointer;
      }

      /* ── Named color chips ──────────────── */
      #palette-color-chips {
        display: flex; gap: 2px; flex-wrap: wrap;
        flex-shrink: 0; min-height: 0;
      }
      .palette-chip {
        display: inline-flex; align-items: center; gap: 3px;
        padding: 1px 4px 1px 3px;
        border: 1px solid var(--border); border-radius: var(--radius);
        background: var(--surface-2); cursor: pointer;
        transition: border-color 80ms, background 80ms;
        font-size: 9px; color: var(--text);
      }
      .palette-chip:hover { border-color: var(--border-hi); background: var(--surface-3) }
      .palette-chip-swatch {
        width: 8px; height: 8px; border-radius: 2px;
        border: 1px solid rgba(255,255,255,.15); flex-shrink: 0;
      }
      #palette-chips-label {
        font-size: 8px; color: var(--text-dim);
        text-transform: uppercase; letter-spacing: .04em;
        flex-shrink: 0; align-self: center;
      }

      /* ── Editor File Tabs ─────────────────── */
      #editor-tabs {
        display: flex;
        align-items: stretch;
        overflow-x: auto;
        overflow-y: hidden;
        flex-shrink: 0;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        min-height: 0;
        scrollbar-width: none;
      }
      #editor-tabs:empty { display: none }
      #editor-tabs::-webkit-scrollbar { display: none }
      .editor-tab {
        display: flex;
        align-items: center;
        gap: 3px;
        padding: 0 3px 0 8px;
        height: 24px;
        border-right: 1px solid var(--border);
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
        font-size: 10px;
        color: var(--text-dim);
        background: var(--surface-2);
        transition: color 80ms, background 80ms;
        user-select: none;
        max-width: 150px;
        min-width: 50px;
        position: relative;
      }
      .editor-tab:hover { background: var(--surface-3); color: var(--text) }
      .editor-tab.is-active {
        background: var(--surface) !important;
        color: var(--text) !important;
        border-top: 2px solid var(--accent);
      }
      .editor-tab.is-active::after {
        content: '';
        position: absolute;
        bottom: -1px; left: 0; right: 0;
        height: 1px;
        background: var(--surface);
      }
      .editor-tab-label {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
      }
      .editor-tab-close {
        width: 14px; height: 14px;
        flex-shrink: 0;
        display: flex; align-items: center; justify-content: center;
        border: none !important;
        background: transparent !important;
        color: var(--text-dim) !important;
        padding: 0 !important;
        font-size: 12px !important;
        line-height: 1;
        min-width: 14px !important;
        cursor: pointer !important;
        border-radius: 2px !important;
        opacity: 0;
        transition: opacity 80ms, background 80ms, color 80ms;
      }
      .editor-tab:hover .editor-tab-close,
      .editor-tab.is-active .editor-tab-close { opacity: .6 }
      .editor-tab-close:hover {
        opacity: 1 !important;
        background: rgba(255,255,255,.1) !important;
        color: var(--text) !important;
      }

      /* ── Autocomplete dropdown ──────────── */
      #msc-autocomplete {
        position: fixed;
        display: none;
        z-index: 1000;
        min-width: 140px;
        max-height: 160px;
        overflow-y: auto;
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        padding: 2px;
        font: 10px/1.4 var(--font-mono);
      }
      #msc-autocomplete.is-open { display: block }
      .autocomplete-item {
        padding: 3px 6px;
        cursor: pointer;
        border-radius: 2px;
        color: var(--text);
        white-space: nowrap;
      }
      .autocomplete-item:hover,
      .autocomplete-item.is-selected {
        background: var(--accent-bg);
        color: var(--accent);
      }
      .autocomplete-hint {
        font-size: 8px;
        color: var(--text-dim);
        margin-left: 4px;
      }

      /* ── Used colors bar ──────────────── */
      #editor-used-colors {
        display: flex;
        gap: 2px;
        flex-wrap: wrap;
        flex-shrink: 0;
        min-height: 0;
        padding: 1px 0;
      }
      .editor-color-swatch {
        width: 14px; height: 14px;
        border: 1px solid var(--border);
        border-radius: 2px;
        cursor: pointer;
        transition: border-color 80ms, transform 80ms;
        padding: 0;
        background: none;
      }
      .editor-color-swatch:hover {
        border-color: var(--accent);
        transform: scale(1.15);
        z-index: 2;
      }

      /* ── Toggle chips ─────────────────── */
      .chip-row { display: flex; gap: 2px; flex-wrap: wrap }
      .chip-row label {
        display: inline-flex; align-items: center; gap: 2px;
        padding: 1px 5px;
        background: var(--surface-2); border: 1px solid var(--border);
        border-radius: var(--radius); cursor: pointer;
        transition: background 80ms, border-color 80ms;
        user-select: none;
        font-size: 10px;
      }
      .chip-row label:hover { border-color: var(--border-hi) }
      .chip-row input[type=checkbox] { display: none }
      .chip-row input[type=radio] { display: none }
      .chip-row input[type=checkbox]:checked+span { color: var(--accent) }
      .chip-row input[type=radio]:checked+span { color: var(--accent) }
      .chip-row label:has(input:checked) {
        background: var(--accent-bg); border-color: var(--accent);
      }

      /* ── Pixel canvas area ────────────── */
      #pixel-editor-wrap {
        flex: 1;
        min-width: 0;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg);
        overflow: hidden;
        position: relative;
        touch-action: none;
      }
      #pixel-stage  { position: relative; width: 100%; height: 100%; touch-action: none }
      #pixel-editor { image-rendering: pixelated; background: transparent; border: 0 }
      #pixel-grid-overlay {
        position: absolute; inset: 0;
        pointer-events: none; image-rendering: pixelated;
      }
      #pixel-footer {
        font-size: 9px; color: var(--text-dim);
        display: flex; justify-content: space-between;
        flex-shrink: 0;
        padding: 2px 4px;
      }

      /* ── Pixel bottom bar ──────────────── */
      #pixel-bottom-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 4px 8px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        flex-shrink: 0;
      }
      .bar-group {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .bar-group label {
        color: var(--text-dim);
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: .04em;
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
      }
      .bar-group input[type=range] {
        -webkit-appearance: none;
        appearance: none;
        width: 60px;
        height: 3px;
        background: var(--border-hi);
        border-radius: 2px;
        outline: none;
        cursor: pointer;
      }
      .bar-group input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 10px; height: 10px;
        border-radius: 50%;
        background: var(--accent);
        border: none;
        cursor: pointer;
      }
      .bar-group input[type=range]::-moz-range-thumb {
        width: 10px; height: 10px;
        border-radius: 50%;
        background: var(--accent);
        border: none;
        cursor: pointer;
      }
      .bar-group span {
        min-width: 20px;
        color: var(--text-dim);
        font-size: 10px;
      }
      .bar-divider {
        width: 1px;
        height: 12px;
        background: var(--border-hi);
        flex-shrink: 0;
      }

      /* ── Docs ──────────────────────────── */
      #docs-search {
        width: 100%; padding: 4px 6px;
        border-radius: var(--radius);
        background: var(--bg); border: 1px solid var(--border);
        color: var(--text); font: inherit;
        flex-shrink: 0;
      }
      #docs-search::placeholder { color: var(--text-dim) }
      #docs-results {
        display: flex; flex-direction: column; gap: 2px;
        max-height: 160px; overflow: auto;
        flex-shrink: 0;
      }
      .doc-item {
        text-align: left;
        background: var(--surface-2); border: 1px solid var(--border);
        color: var(--text); border-radius: var(--radius);
        padding: 4px 6px; cursor: pointer;
        transition: border-color 80ms; font: inherit;
      }
      .doc-item:hover { border-color: var(--border-hi) }
      .doc-item small {
        display: block;
        color: var(--text-dim);
        margin-top: 2px;
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: .05em;
      }
      .doc-item.is-active { border-color: var(--accent); background: var(--accent-bg) }
      #docs-content {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 6px;
        background: var(--bg);
        font-size: 10px; line-height: 1.5;
        color: var(--text);
        overflow: auto;
        flex: 1;
      }
      .docs-empty { color: var(--text-dim) }
      .docs-outline {
        border: 1px solid var(--border);
        background: var(--surface-2);
        border-radius: var(--radius);
        padding: 4px 6px;
        margin-bottom: 6px;
      }
      .docs-outline-title {
        color: var(--text-dim);
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: .06em;
        margin-bottom: 3px;
      }
      .docs-outline-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .docs-outline-list a { color: var(--text); text-decoration: none }
      .docs-outline-list a:hover { color: var(--accent) }
      .docs-article { display: flex; flex-direction: column; gap: 6px }
      .docs-article-header {
        display: flex; align-items: center;
        justify-content: space-between; gap: 6px;
      }
      .docs-article-title { font-size: 12px; color: var(--text) }
      .docs-badge {
        border: 1px solid var(--accent);
        color: var(--accent);
        background: var(--accent-bg);
        border-radius: var(--radius);
        font-size: 9px;
        padding: 1px 5px;
        text-transform: uppercase;
        letter-spacing: .06em;
        white-space: nowrap;
      }
      .docs-section-title { margin-top: 2px; font-size: 11px; color: var(--accent) }
      .docs-subsection-title { margin-top: 2px; font-size: 10px; color: var(--text) }
      .docs-paragraph { color: var(--text) }
      .docs-list { padding-left: 14px; display: flex; flex-direction: column; gap: 2px }
      .docs-list li { color: var(--text) }
      .docs-code {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 4px;
        background: var(--surface-2);
        white-space: pre-wrap;
        overflow-wrap: anywhere;
      }

      /* ── Canvas ───────────────────────── */
      canvas { display: block; border: 1px solid var(--border); image-rendering: pixelated }

      /* ── Syntax highlighting ──────────── */
      .msc-keyword { color: #56b6c2 }
      .msc-string  { color: #98c379 }
      .msc-comment { color: #6a9955 }
      .msc-symbol  { color: #e5c07b }

      /* ── File tree action buttons ─────── */
      .ftv-header-actions {
        display: flex;
        align-items: center;
        gap: 1px;
        flex-shrink: 0;
      }
      .ftv-header-btn {
        font: 10px/1 var(--font-mono) !important;
        width: 20px !important; height: 20px !important;
        min-width: 20px !important;
        padding: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: transparent !important;
        border: 1px solid transparent !important;
        color: var(--text-dim) !important;
        border-radius: 2px !important;
        cursor: pointer !important;
        transition: all 80ms !important;
      }
      .ftv-header-btn:hover {
        background: var(--surface-3) !important;
        border-color: var(--border) !important;
        color: var(--text) !important;
      }

      /* ── Header dropdown menus ────────── */
      .header-menu-anchor { position: relative; display: inline-block }
      .header-dropdown {
        position: absolute;
        top: 100%; left: 0;
        z-index: 100;
        min-width: 180px;
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 3px;
        display: none;
        flex-direction: column;
      }
      .header-dropdown.is-open { display: flex }
      .header-dropdown-row {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
      }
      .header-dropdown-label {
        font-size: 9px;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: .04em;
        white-space: nowrap;
      }
      .header-dropdown-select {
        flex: 1;
        padding: 1px 3px;
        font: 10px var(--font-mono);
        background: var(--surface-3);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: var(--radius);
        cursor: pointer;
      }

      /* ── Add-file dropdown ─────────── */
      .ftv-menu-anchor { position: relative }
      .ftv-dropdown {
        position: absolute;
        top: 100%; right: 0;
        z-index: 100;
        min-width: 160px;
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 3px;
        display: none;
        flex-direction: column;
      }
      .ftv-dropdown.is-open { display: flex }
      .ftv-dropdown-item {
        font: 10px/1.2 var(--font-mono) !important;
        text-align: left !important;
        padding: 4px 8px !important;
        background: transparent !important;
        border: none !important;
        color: var(--text) !important;
        border-radius: 2px !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        width: 100% !important;
        min-width: auto !important;
        transition: background 60ms !important;
      }
      .ftv-dropdown-item:hover {
        background: var(--accent-bg) !important;
        color: var(--accent) !important;
      }
      .ftv-dropdown-sep {
        height: 1px;
        background: var(--border);
        margin: 2px 4px;
      }
      .ftv-dropdown-icon {
        width: 12px; display: inline-flex;
        align-items: center; justify-content: center;
        flex-shrink: 0;
      }
      .ftv-dropdown-icon svg {
        width: 12px; height: 12px;
        fill: none; stroke: currentColor;
        stroke-width: 1.4; stroke-linecap: round; stroke-linejoin: round;
      }
      .ftv-dropdown-label { flex: 1 }
      .ftv-dropdown-hint {
        font-size: 8px;
        color: var(--text-dim);
        letter-spacing: .02em;
      }

      /* Tree items */
      .ftv-list { list-style: none; margin: 0; padding: 0 }
      .ftv-nested { padding-left: 0 }
      .ftv-item { margin: 0; padding: 0 }
      .ftv-row {
        display: flex;
        align-items: center;
        gap: 3px;
        padding: 2px 6px 2px 3px;
        cursor: pointer;
        transition: background 60ms;
        white-space: nowrap;
        font-size: 10px;
        min-height: 20px;
        border-radius: 2px;
        margin: 0 3px;
      }
      .ftv-row:hover { background: rgba(255,255,255,.04) }
      .ftv-row.ftv-active { background: var(--accent-bg); color: var(--accent) }
      .ftv-chevron {
        width: 10px; font-size: 8px;
        color: var(--text-dim); text-align: center;
        flex-shrink: 0; cursor: pointer;
      }
      .ftv-chevron-spacer { width: 10px; flex-shrink: 0 }
      .ftv-icon {
        font-size: 10px; flex-shrink: 0;
        width: 14px; text-align: center;
        display: flex; align-items: center; justify-content: center;
      }
      .ftv-icon svg {
        width: 12px; height: 12px;
        fill: none; stroke: currentColor;
        stroke-width: 1.4; stroke-linecap: round; stroke-linejoin: round;
      }
      .ftv-folder-icon { color: var(--accent) }
      .ftv-script-icon { color: var(--info) }
      .ftv-image-icon { color: #c586c0 }
      .ftv-label {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text);
      }
      .ftv-row.ftv-active .ftv-label { color: var(--accent) }
      .ftv-entry-star {
        color: #e8a317;
        font-size: 10px;
        margin-left: 3px;
        flex-shrink: 0;
      }
      .ftv-actions {
        display: none;
        gap: 1px;
        margin-left: auto;
        flex-shrink: 0;
      }
      .ftv-row:hover .ftv-actions { display: flex }
      .ftv-action-btn {
        background: none !important;
        border: none !important;
        padding: 0 2px !important;
        font-size: 9px;
        color: var(--text-dim);
        cursor: pointer;
        line-height: 1;
        min-width: auto !important;
        min-height: auto !important;
        border-radius: 2px !important;
        opacity: .7;
        transition: all 80ms;
      }
      .ftv-action-btn:hover {
        color: var(--accent) !important;
        background: var(--accent-bg) !important;
        opacity: 1;
      }
      .ftv-rename-input {
        flex: 1;
        font: 10px/1 var(--font-mono);
        background: var(--bg);
        border: 1px solid var(--accent);
        color: var(--text);
        padding: 1px 3px;
        border-radius: 2px;
        outline: none;
      }

      /* ── Scrollbar ────────────────────── */
      ::-webkit-scrollbar { width: 4px; height: 4px }
      ::-webkit-scrollbar-track { background: transparent }
      ::-webkit-scrollbar-thumb { background: var(--bg-panel-border, #16243E); border-radius: 3px }
      ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan, #00F0FF) }

      /* ── Editor Toolbar — compact ─────── */
      .editor-toolbar {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 3px 6px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        flex-shrink: 0;
        min-height: 26px;
      }
      .editor-toolbar-icon {
        font-size: 11px;
        color: var(--accent);
        flex-shrink: 0;
        display: flex;
        align-items: center;
      }
      .editor-toolbar-icon svg {
        width: 12px; height: 12px;
        fill: none; stroke: var(--accent);
        stroke-width: 1.5;
      }
      .editor-toolbar-name {
        font-size: 10px;
        color: var(--text);
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .editor-toolbar-dot {
        color: var(--warning);
        font-size: 14px;
        line-height: 1;
        flex-shrink: 0;
        animation: pulse-dot 2s ease-in-out infinite;
      }
      @keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:.3} }
      .editor-toolbar-badge {
        font-size: 8px;
        color: var(--text-dim);
        background: var(--surface-3);
        padding: 1px 4px;
        border-radius: 2px;
        flex-shrink: 0;
        letter-spacing: .04em;
        text-transform: uppercase;
      }
      .editor-toolbar-spacer { flex: 1 }
      .toolbar-btn {
        font: 10px/1.2 var(--font-mono) !important;
        padding: 2px 6px !important;
        background: var(--surface-3) !important;
        border: 1px solid var(--border) !important;
        color: var(--text-dim) !important;
        border-radius: var(--radius) !important;
        cursor: pointer !important;
        transition: all 80ms !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 3px !important;
        min-width: auto !important;
        width: auto !important;
        height: auto !important;
      }
      .toolbar-btn:hover {
        color: var(--text) !important;
        border-color: var(--border-hi) !important;
      }
      .toolbar-btn-accent {
        background: var(--accent-bg) !important;
        border-color: rgba(0,240,255,.3) !important;
        color: var(--accent) !important;
      }
      .toolbar-btn-accent:hover {
        background: rgba(0,240,255,.2) !important;
        border-color: var(--accent) !important;
      }

      /* ── Line Numbers ──────────────────── */
      #line-numbers {
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 32px;
        padding: 4px 4px 4px 2px;
        background: rgba(5,10,20,.85);
        border-right: 1px solid var(--border);
        color: #2A4060;
        font: 11px/1.45 var(--font-mono);
        text-align: right;
        white-space: pre;
        overflow-y: hidden;
        user-select: none;
        pointer-events: none;
        z-index: 1;
      }

      /* ── Header buttons — icon-style ──── */
      .hdr-icon-btn {
        width: 26px; height: 26px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        padding: 0 !important;
        background: var(--surface-2) !important;
        border: 1px solid var(--border) !important;
        border-radius: var(--radius) !important;
        color: var(--text-dim) !important;
        cursor: pointer;
        transition: all 80ms;
        flex-shrink: 0;
      }
      .hdr-icon-btn:hover {
        background: var(--surface-3) !important;
        border-color: var(--border-hi) !important;
        color: var(--text) !important;
      }
      .hdr-icon-btn svg {
        width: 14px; height: 14px;
        fill: none; stroke: currentColor;
        stroke-width: 1.4; stroke-linecap: round; stroke-linejoin: round;
      }
      .header-btn-primary {
        background: var(--accent) !important;
        color: var(--bg) !important;
        border-color: var(--accent) !important;
        font-weight: 600;
      }
      .header-btn-primary:hover {
        background: var(--accent-hover) !important;
        border-color: var(--accent-hover) !important;
      }
      .header-btn-primary svg { stroke: var(--bg) }
      .header-file-info {
        font-size: 10px;
        color: var(--text-dim);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 160px;
        display: flex;
        align-items: center;
        gap: 3px;
      }
      .header-file-dot {
        width: 5px; height: 5px;
        border-radius: 50%;
        background: var(--success);
        flex-shrink: 0;
        display: inline-block;
      }

      /* ── Pane toggle buttons ──────────── */
      .pane-toggle-btn {
        width: 26px; height: 26px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text-dim);
        cursor: pointer;
        transition: all 80ms;
        flex-shrink: 0;
      }
      .pane-toggle-btn:hover {
        background: var(--surface-3);
        border-color: var(--border-hi);
        color: var(--text);
      }
      .pane-toggle-btn.is-active {
        background: var(--accent-bg);
        border-color: var(--accent);
        color: var(--accent);
      }
      .pane-toggle-btn svg {
        width: 14px; height: 14px;
        fill: none; stroke: currentColor;
        stroke-width: 1.4; stroke-linecap: round; stroke-linejoin: round;
      }

      /* ── Status Bar — compact 20px ─────── */
      #status-bar {
        grid-area: status;
        height: 20px; min-height: 20px;
        display: flex; align-items: center;
        padding: 0 8px;
        background: var(--surface);
        border-top: 1px solid var(--border);
        font-size: 9px; color: var(--text-dim);
        gap: 12px; flex-shrink: 0;
      }
      .status-item { display: flex; align-items: center; gap: 3px; white-space: nowrap }
      .status-spacer { flex: 1 }
      .status-accent { color: var(--accent) }
    </style>
  </head>
  <body>
    <div id="mozaic-app">

      <!-- ── Header — compact 32px toolbar with icon buttons ── -->
      <header id="mozaic-header">
        <div id="header-brand">
          <span id="header-logo">&#9672;</span>
          <span id="header-title">Mozaic</span>
        </div>
        <div id="header-divider"></div>

        <!-- Toggle: left sidebar (file tree) -->
        <button id="toggle-sidebar-btn" class="pane-toggle-btn is-active" type="button" title="Toggle file explorer (Ctrl+B)">
          <svg viewBox="0 0 16 16"><path d="M2 2h4v12H2zM6 2h8v12H6"/></svg>
        </button>

        <div id="header-actions">
          <div class="header-menu-anchor">
            <button id="new-rom-button" type="button" class="hdr-icon-btn" title="Create new ROM">
              <svg viewBox="0 0 16 16"><path d="M8 3v10M3 8h10"/></svg>
            </button>
            <div id="new-rom-menu" class="header-dropdown">
              <div class="header-dropdown-row">
                <label class="header-dropdown-label">Palette:</label>
                <select id="new-rom-palette" class="header-dropdown-select"></select>
              </div>
              <div class="ftv-dropdown-sep"></div>
              <button type="button" class="ftv-dropdown-item" data-new-rom="empty">
                <span class="ftv-dropdown-label">Empty ROM</span>
                <span class="ftv-dropdown-hint">Blank</span>
              </button>
              <button type="button" class="ftv-dropdown-item" data-new-rom="amiga">
                <span class="ftv-dropdown-label">Amiga Demo</span>
                <span class="ftv-dropdown-hint">Classic</span>
              </button>
              <button type="button" class="ftv-dropdown-item" data-new-rom="checkerboard">
                <span class="ftv-dropdown-label">Checkerboard</span>
                <span class="ftv-dropdown-hint">Pattern</span>
              </button>
            </div>
          </div>
          <button id="open-rom-button" type="button" class="hdr-icon-btn" title="Open ROM image">
            <svg viewBox="0 0 16 16"><path d="M3 2h5l1 1h4v10H3z"/></svg>
          </button>
          <button id="open-script-button" type="button" class="hdr-icon-btn" title="Import script file">
            <svg viewBox="0 0 16 16"><path d="M8 2v9m0 0l-3-3m3 3l3-3"/><path d="M3 13h10"/></svg>
          </button>
          <div class="header-sep"></div>
          <button id="save-rom-button" type="button" class="hdr-icon-btn" title="Export ROM as PNG">
            <svg viewBox="0 0 16 16"><path d="M3 3h7l3 3v7H3z"/><path d="M5 3v3h4V3"/><path d="M5 9h6v4H5z"/></svg>
          </button>
          <button id="open-config-button" type="button" class="hdr-icon-btn" title="Edit engine config">
            <svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="2.5"/><path d="M8 1.5v2M8 12.5v2M1.5 8h2M12.5 8h2M3.3 3.3l1.4 1.4M11.3 11.3l1.4 1.4M3.3 12.7l1.4-1.4M11.3 4.7l1.4-1.4"/></svg>
          </button>
          <button id="reload-config-button" type="button" class="hdr-icon-btn" title="Reload config">
            <svg viewBox="0 0 16 16"><path d="M3 8a5 5 0 019-3"/><path d="M12 2v3h-3"/><path d="M13 8a5 5 0 01-9 3"/><path d="M4 14v-3h3"/></svg>
          </button>
          <div class="header-sep"></div>
          <button id="restart-button" type="button" class="hdr-icon-btn header-btn-primary" title="Run game (F5)">
            <svg viewBox="0 0 16 16"><polygon points="4,2 14,8 4,14"/></svg>
          </button>
          <div class="header-sep"></div>
          <span id="header-file-info" class="header-file-info"></span>
        </div>

        <!-- Toggle: right panel -->
        <button id="toggle-panel-btn" class="pane-toggle-btn is-active" type="button" title="Toggle editor panel (Ctrl+J)">
          <svg viewBox="0 0 16 16"><path d="M10 2h4v12h-4zM2 2h8v12H2"/></svg>
        </button>
      </header>

      <!-- ── Workspace ─────────────────────── -->
      <div id="mozaic-workspace">

        <!-- LEFT SIDEBAR: File tree ────────── -->
        <aside id="left-sidebar">
          <div id="file-tree-panel">
            <div id="file-tree-header">
              <span id="file-tree-title">Explorer</span>
              <div class="ftv-header-actions">
                <div class="ftv-menu-anchor">
                  <button id="ftv-add-btn" type="button" class="ftv-header-btn" title="Add file">+</button>
                  <div id="ftv-add-menu" class="ftv-dropdown">
                    <button type="button" class="ftv-dropdown-item" data-action="new-script">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><path d="M4 1.5h5.5l3 3V14H4z"/><path d="M9.5 1.5v3h3"/></svg></span>
                      <span class="ftv-dropdown-label">New Script</span>
                      <span class="ftv-dropdown-hint">.msc</span>
                    </button>
                    <button type="button" class="ftv-dropdown-item" data-action="new-mzk">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><path d="M4 1.5h5.5l3 3V14H4z"/><path d="M9.5 1.5v3h3"/><text x="8" y="12" text-anchor="middle" font-size="8" fill="currentColor">M</text></svg></span>
                      <span class="ftv-dropdown-label">New MZK Asset</span>
                      <span class="ftv-dropdown-hint">.mzk</span>
                    </button>
                    <button type="button" class="ftv-dropdown-item" data-action="new-text">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><path d="M4 1.5h8V14H4z"/><line x1="6" y1="5" x2="10" y2="5"/><line x1="6" y1="7.5" x2="10" y2="7.5"/><line x1="6" y1="10" x2="9" y2="10"/></svg></span>
                      <span class="ftv-dropdown-label">New Text File</span>
                      <span class="ftv-dropdown-hint">.txt</span>
                    </button>
                    <button type="button" class="ftv-dropdown-item" data-action="new-json">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><path d="M5 2.5C3.5 2.5 3 3.5 3 4.5v2c0 .8-.5 1.5-1 1.5.5 0 1 .7 1 1.5v2c0 1 .5 2 2 2"/><path d="M11 2.5c1.5 0 2 1 2 2v2c0 .8.5 1.5 1 1.5-.5 0-1 .7-1 1.5v2c0 1-.5 2-2 2"/></svg></span>
                      <span class="ftv-dropdown-label">New JSON File</span>
                      <span class="ftv-dropdown-hint">.json</span>
                    </button>
                    <button type="button" class="ftv-dropdown-item" data-action="new-markdown">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><rect x="1.5" y="3" width="13" height="10" rx="1.5"/><path d="M4 10V6l2 2.5L8 6v4"/><path d="M11 8.5l1.5-1.5L14 8.5"/></svg></span>
                      <span class="ftv-dropdown-label">New Markdown</span>
                      <span class="ftv-dropdown-hint">.md</span>
                    </button>
                    <button type="button" class="ftv-dropdown-item" data-action="new-image">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" rx="1.5"/></svg></span>
                      <span class="ftv-dropdown-label">New Image</span>
                      <span class="ftv-dropdown-hint">64×64</span>
                    </button>
                    <button type="button" class="ftv-dropdown-item" data-action="new-folder">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><path d="M1.5 4h5l1.5-1.5H14v10H1.5z"/></svg></span>
                      <span class="ftv-dropdown-label">New Folder</span>
                    </button>
                    <div class="ftv-dropdown-sep"></div>
                    <button type="button" class="ftv-dropdown-item" data-action="new-project">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><path d="M1.5 4h5l1.5-1.5H14v10H1.5z"/><path d="M8 7v4M6 9h4" stroke="currentColor" stroke-width="1.2"/></svg></span>
                      <span class="ftv-dropdown-label">New Project</span>
                    </button>
                    <div class="ftv-dropdown-sep"></div>
                    <button type="button" class="ftv-dropdown-item" data-action="import-script">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><path d="M8 2v9m0 0l-3-3m3 3l3-3M3 13h10"/></svg></span>
                      <span class="ftv-dropdown-label">Import Script…</span>
                      <span class="ftv-dropdown-hint">.msc .txt .json .md</span>
                    </button>
                    <button type="button" class="ftv-dropdown-item" data-action="import-image">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><path d="M8 2v9m0 0l-3-3m3 3l3-3M3 13h10"/></svg></span>
                      <span class="ftv-dropdown-label">Import Image…</span>
                      <span class="ftv-dropdown-hint">.png .jpg</span>
                    </button>
                    <button type="button" class="ftv-dropdown-item" data-action="import-rom">
                      <span class="ftv-dropdown-icon"><svg viewBox="0 0 16 16"><path d="M8 2v9m0 0l-3-3m3 3l3-3M3 13h10"/></svg></span>
                      <span class="ftv-dropdown-label">Import ROM…</span>
                      <span class="ftv-dropdown-hint">.mzk .png</span>
                    </button>
                  </div>
                </div>
              </div>
              <span id="file-tree-toggle" style="cursor:pointer">▾</span>
            </div>
            <div id="file-tree-container"></div>
          </div>
        </aside>

        <!-- LEFT SPLITTER -->
        <div id="left-split-handle"></div>

        <!-- CENTER: Game canvas ──────────── -->
        <main id="canvas-area">
          <canvas id="mozaic-canvas"></canvas>
          <div id="compiler-console"></div>
          <div id="input-debug"></div>
        </main>

        <!-- SPLIT HANDLE ────────────────── -->
        <div id="split-handle"></div>

        <!-- RIGHT: Tabbed editor panel ──── -->
        <div id="side-panel">
          <!-- Tab bar with symbolic icons -->
          <div id="tab-bar">
            <button class="tab-btn is-active" data-tab="script" type="button" title="Script Editor">
              <svg class="tab-icon" viewBox="0 0 16 16"><path d="M4 2h6l3 3v9H4z"/><path d="M10 2v3h3"/></svg>
              <span>Script</span>
            </button>
            <button class="tab-btn" data-tab="pixel" type="button" title="Pixel Editor">
              <svg class="tab-icon" viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" rx="1"/><path d="M2 10l3-3 2 2 3-4 4 5"/></svg>
              <span>Pixel</span>
            </button>
            <button class="tab-btn" data-tab="debug" type="button" title="Debug Panel">
              <svg class="tab-icon" viewBox="0 0 16 16"><circle cx="8" cy="8" r="5"/><path d="M8 5v3h3"/></svg>
              <span>Debug</span>
            </button>
            <button class="tab-btn" id="toggle-docs-button" data-tab="docs" type="button" title="Documentation">
              <svg class="tab-icon" viewBox="0 0 16 16"><path d="M2 3h5l1 1 1-1h5v10h-5l-1 1-1-1H2z"/></svg>
              <span>Docs</span>
            </button>
          </div>

          <!-- Tab content -->
          <div id="tab-content">

            <!-- Tab: Script Editor ─────── -->
            <section class="tab-pane is-active" id="msc-section">
              <div id="editor-tabs" role="tablist" aria-label="Open editor files"></div>
              <div class="editor-toolbar">
                <span class="editor-toolbar-icon" id="editor-file-icon"><svg viewBox="0 0 16 16"><path d="M4 2h6l3 3v9H4z" fill="none" stroke="currentColor" stroke-width="1.3"/><path d="M10 2v3h3" fill="none" stroke="currentColor" stroke-width="1.3"/></svg></span>
                <span class="editor-toolbar-name" id="editor-file-name">untitled.msc</span>
                <span class="editor-toolbar-dot" id="editor-modified-dot" hidden>&#9679;</span>
                <span class="editor-toolbar-badge" id="text-editor-title">Script</span>
                <span class="editor-toolbar-spacer"></span>
                <button id="save-file-button" type="button" class="toolbar-btn toolbar-btn-accent" title="Save (Ctrl+S)">&#10003; Save</button>
                <button id="download-file-button" type="button" class="toolbar-btn" title="Download file">&#8595;</button>
              </div>
              <div id="palette-color-chips" aria-label="Named palette colors — click to insert into script"></div>
              <div id="editor-used-colors" aria-label="Palette colors — click to insert hex"></div>
              <div id="msc-editor-wrap">
                <div id="line-numbers" aria-hidden="true">1</div>
                <pre id="msc-highlight"></pre>
                <textarea id="msc-editor" spellcheck="false" aria-label="MSC editor"></textarea>
              </div>
              <div id="msc-status"></div>
            </section>

            <!-- Tab: Pixel Editor ──────── -->
            <section class="tab-pane" id="pixel-section">
              <div class="editor-toolbar">
                <span class="editor-toolbar-icon"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" rx="1" fill="none" stroke="currentColor" stroke-width="1.3"/><circle cx="5" cy="5.5" r="1.2" fill="currentColor" opacity=".4"/><path d="M2 11l3-3 2 2 3-4 4 5" fill="none" stroke="currentColor" stroke-width="1.3"/></svg></span>
                <span class="editor-toolbar-name" id="pixel-file-name">No image</span>
                <span class="editor-toolbar-badge" id="pixel-file-size"></span>
                <span class="editor-toolbar-spacer"></span>
                <button id="resize-pixel-button" type="button" class="toolbar-btn" title="Resize canvas">Resize</button>
                <button id="download-pixel-button" type="button" class="toolbar-btn" title="Download as PNG">&#8595; PNG</button>
              </div>
              <div id="pixel-controls">
                <div class="pixel-row">
                  <input id="pixel-color" type="color" value="#ff00ff" />
                  <button id="palette-add-button" type="button" title="Add to palette">+</button>
                  <button id="palette-update-button" type="button" title="Update active palette slot">&#8635;</button>
                  <button id="palette-preset-button" type="button" title="Palette presets">Presets</button>
                  <button id="palette-import-button" type="button" title="Import palette">&#8593;</button>
                  <button id="palette-export-button" type="button" title="Export palette">&#8595;</button>
                </div>
                <div id="palette-swatches"></div>
              </div>
              <div class="chip-row">
                <label><input id="stylus-only-toggle" type="checkbox" /><span>Stylus</span></label>
                <label><input id="pressure-size-toggle" type="radio" name="pressure-mode" checked /><span>P:Size</span></label>
                <label><input id="pressure-dither-toggle" type="radio" name="pressure-mode" /><span>P:Dither</span></label>
              </div>
              <div id="pixel-workspace">
                <div id="pixel-toolbox">
                  <button id="preset-pencil-button" class="tool-btn" type="button" title="Pencil (B)"><svg viewBox="0 0 16 16"><path d="M2.5 13.5l1-4L11 2l2.5 2.5-7.5 7.5z"/><path d="M9 4l3 3"/></svg></button>
                  <button id="preset-brush-button" class="tool-btn" type="button" title="Brush (3px)"><svg viewBox="0 0 16 16"><path d="M10 1.5l4 4-6 6H4v-4z"/><path d="M3 12.5c-1 1-1.5 2-1 2.5s1.5 0 2.5-1"/></svg></button>
                  <button id="preset-eraser-button" class="tool-btn" type="button" title="Eraser (E)"><svg viewBox="0 0 16 16"><path d="M6 14h7M3.5 10l4-6.5 5 5-4 6.5z"/><path d="M3.5 10l5 5"/></svg></button>
                  <button id="eraser-toggle-button" class="tool-btn" type="button" title="Toggle eraser (E)"><svg viewBox="0 0 16 16"><path d="M6 14h7M3.5 10l4-6.5 5 5-4 6.5z"/><path d="M3.5 10l5 5"/></svg></button>
                  <button id="fill-tool-button" class="tool-btn" type="button" title="Fill (G)"><svg viewBox="0 0 16 16"><path d="M3 13l2-6 6-4 2 2-4 6z"/><path d="M12 9c1 1 2.5 3 2 4s-2-.5-2-2"/></svg></button>
                  <button id="select-tool-button" class="tool-btn" type="button" title="Select (M)"><svg viewBox="0 0 16 16"><rect x="2.5" y="2.5" width="11" height="11" rx=".5" stroke-dasharray="2 2"/></svg></button>
                  <button id="pipette-tool-button" class="tool-btn" type="button" title="Pipette (I)"><svg viewBox="0 0 16 16"><path d="M12 2l2 2-1.5 1.5-2-2z"/><path d="M10.5 5.5l-6 6L3 14l2.5-1.5 6-6z"/></svg></button>
                  <div class="toolbox-sep"></div>
                  <button id="entity-brush-button" class="tool-btn" type="button" title="Entity Brush (N)"><svg viewBox="0 0 16 16"><circle cx="8" cy="6" r="3"/><path d="M4 14c0-2.5 1.8-4 4-4s4 1.5 4 4"/></svg></button>
                  <button id="data-inspector-button" class="tool-btn" type="button" title="Data Inspector (D)"><svg viewBox="0 0 16 16"><circle cx="7" cy="7" r="4"/><path d="M10 10l3.5 3.5"/></svg></button>
                  <div class="toolbox-sep"></div>
                  <button id="undo-button" class="tool-btn" type="button" title="Undo (Ctrl+Z)"><svg viewBox="0 0 16 16"><path d="M4 7l-2.5-2.5L4 2"/><path d="M1.5 4.5H10a4 4 0 010 8H6"/></svg></button>
                  <button id="redo-button" class="tool-btn" type="button" title="Redo (Ctrl+Y)"><svg viewBox="0 0 16 16"><path d="M12 7l2.5-2.5L12 2"/><path d="M14.5 4.5H6a4 4 0 000 8h4"/></svg></button>
                  <button id="clear-button" class="tool-btn" type="button" title="Clear canvas"><svg viewBox="0 0 16 16"><path d="M3 4h10M6 4V3h4v1M4.5 4v8.5h7V4"/><line x1="7" y1="6.5" x2="7" y2="10.5"/><line x1="9" y1="6.5" x2="9" y2="10.5"/></svg></button>
                </div>
                <div id="pixel-editor-wrap">
                  <div id="pixel-stage">
                    <canvas id="pixel-editor" width="64" height="64"></canvas>
                    <canvas id="pixel-grid-overlay" width="64" height="64"></canvas>
                  </div>
                </div>
              </div>
              <div id="pixel-footer">
                <span>Alt+Click picks · RClick color pick · Scroll zoom</span>
                <span id="pixel-coords">&ndash;, &ndash;</span>
              </div>
              <div id="pixel-bottom-bar">
                <div class="bar-group">
                  <label for="pixel-zoom">Zoom</label>
                  <input id="pixel-zoom" type="range" min="1" max="64" value="8" />
                  <span id="zoom-level">8&times;</span>
                </div>
                <div class="bar-divider"></div>
                <div class="bar-group">
                  <label for="brush-size">Size</label>
                  <input id="brush-size" type="range" min="1" max="9" value="1" />
                  <span id="brush-size-label">1</span>
                </div>
              </div>
            </section>

            <!-- Tab: Debug ─────────────── -->
            <section class="tab-pane" id="pane-debug">
              <div class="section-label">Layers</div>
              <div class="chip-row">
                <label><input id="layer-static-toggle" type="radio" name="editor-layer" checked /><span>Static</span></label>
                <label><input id="layer-ecs-toggle" type="radio" name="editor-layer" /><span>ECS</span></label>
              </div>
              <div class="section-label">Grid</div>
              <div class="chip-row">
                <label><input id="grid-inline-toggle" type="checkbox" checked /><span>Grid</span></label>
                <label><input id="grid-custom-toggle" type="checkbox" /><span>Custom</span></label>
              </div>
              <div class="pixel-row">
                <label for="grid-size">Cell</label>
                <input id="grid-size" type="number" min="1" max="64" value="8" />
                <label for="grid-major">Major</label>
                <input id="grid-major" type="number" min="1" max="64" value="4" />
              </div>
              <div class="section-label">Overlays</div>
              <div class="chip-row">
                <label><input id="debug-collision-toggle" type="checkbox" /><span>Collision</span></label>
                <label><input id="debug-path-toggle" type="checkbox" /><span>Paths</span></label>
                <label><input id="debug-points-toggle" type="checkbox" /><span>Pts</span></label>
                <label><input id="debug-ids-toggle" type="checkbox" /><span>IDs</span></label>
              </div>
            </section>

            <!-- Tab: Docs ──────────────── -->
            <section class="tab-pane" id="docs-pane">
              <input id="docs-search" type="text" placeholder="Search docs..." />
              <div id="docs-results"></div>
              <div id="docs-content">Select a document.</div>
            </section>

          </div><!-- #tab-content -->
        </div><!-- #side-panel -->

      </div><!-- #mozaic-workspace -->

      <!-- ── Status Bar ──────────────────── -->
      <div id="status-bar">
        <span class="status-item" id="status-file-info">Ready</span>
        <span class="status-spacer"></span>
        <span class="status-item" id="status-cursor-pos"></span>
        <span class="status-item">Mozaic Engine</span>
      </div>

      <!-- ── Modal ────────────────────────── -->
      <div id="modal-overlay">
        <div class="modal-window">
          <div class="modal-header">
            <span class="modal-title">Title</span>
            <button class="modal-close">&times;</button>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button class="btn modal-close-btn">Cancel</button>
            <button class="btn modal-btn-primary">OK</button>
          </div>
        </div>
      </div>

    </div><!-- #mozaic-app -->
    <div id="msc-autocomplete" role="listbox" aria-label="Autocomplete suggestions"></div>
    <script type="module" src="/src/index.ts"></script>
  </body>
</html>
