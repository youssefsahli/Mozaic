<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mozaic</title>
    <style>
      /* ── CSS Variables ────────────────────────── */
      :root {
        --bg:         #0c0c0c;
        --surface:    #141414;
        --surface-2:  #1a1a1a;
        --surface-3:  #212121;
        --border:     #232323;
        --border-hi:  #383838;
        --text:       #ccc;
        --text-dim:   #5a5a5a;
        --accent:     #5b9;
        --accent-bg:  rgba(85,187,153,.12);
        --radius:     4px;
        --font-mono:  ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
        --header-h:   42px;
        --tab-h:      34px;
        --handle-w:   5px;
        --ease:       200ms cubic-bezier(0.4,0,0.2,1);
      }

      /* ── Reset ────────────────────────────────── */
      *, *::before, *::after { margin:0; padding:0; box-sizing:border-box }

      body {
        background: var(--bg);
        color: var(--text);
        font: 12px/1.4 var(--font-mono);
        height: 100dvh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* ── Header ───────────────────────────────── */
      #mozaic-header {
        height: var(--header-h);
        min-height: var(--header-h);
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 14px;
        flex-shrink: 0;
      }
      #header-brand {
        display: flex;
        align-items: center;
        gap: 7px;
        color: var(--accent);
        font-weight: bold;
        letter-spacing: .04em;
        white-space: nowrap;
        flex-shrink: 0;
      }
      #header-logo { font-size: 15px }
      #header-title { font-size: 12px; text-transform: uppercase; letter-spacing: .1em }
      #header-divider {
        width: 1px;
        height: 20px;
        background: var(--border-hi);
        flex-shrink: 0;
      }
      #header-actions {
        display: flex;
        align-items: center;
        gap: 4px;
        flex: 1;
        flex-wrap: wrap;
      }
      .header-sep {
        width: 1px;
        height: 16px;
        background: var(--border-hi);
        flex-shrink: 0;
        margin: 0 4px;
      }

      /* ── Workspace (split layout) ──────────────── */
      #mozaic-app {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }
      #mozaic-workspace {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* ── Canvas area (left) ────────────────────── */
      #canvas-area {
        flex: 3 1 0%;
        min-width: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: var(--bg);
        padding: 8px;
      }
      #mozaic-canvas {
        max-width: 100%;
        max-height: 100%;
      }

      /* ── Split handle ──────────────────────────── */
      #split-handle {
        width: var(--handle-w);
        background: var(--border);
        cursor: col-resize;
        flex-shrink: 0;
        transition: background 120ms;
        position: relative;
      }
      #split-handle:hover,
      #split-handle.is-dragging {
        background: var(--accent);
      }
      #split-handle::before {
        content: '';
        position: absolute;
        inset: 0 -4px;
      }

      /* ── Side panel (right) ────────────────────── */
      #side-panel {
        flex: 2 1 0%;
        min-width: 280px;
        display: flex;
        flex-direction: column;
        background: var(--surface);
        border-left: 1px solid var(--border);
        overflow: hidden;
      }

      /* ── Tab bar ───────────────────────────────── */
      #tab-bar {
        display: flex;
        align-items: stretch;
        height: var(--tab-h);
        min-height: var(--tab-h);
        background: var(--surface-2);
        border-bottom: 1px solid var(--border);
        gap: 0;
        flex-shrink: 0;
      }
      .tab-btn {
        flex: 1;
        padding: 0 12px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-dim);
        font: 11px/1 var(--font-mono);
        text-transform: uppercase;
        letter-spacing: .06em;
        cursor: pointer;
        transition: color var(--ease), border-color var(--ease), background var(--ease);
        white-space: nowrap;
      }
      .tab-btn:hover {
        color: var(--text);
        background: rgba(255,255,255,.03);
      }
      .tab-btn.is-active {
        color: var(--accent) !important;
        border-bottom-color: var(--accent) !important;
        background: var(--accent-bg) !important;
      }
      .tab-btn[hidden] { display: none }

      /* ── Tab content ───────────────────────────── */
      #tab-content {
        flex: 1;
        overflow: hidden;
        position: relative;
      }
      .tab-pane {
        position: absolute;
        inset: 0;
        display: none;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 10px;
        gap: 8px;
      }
      .tab-pane.is-active {
        display: flex;
      }

      /* ── Section label ────────────────────────── */
      .section-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: .06em;
        color: var(--text-dim);
      }

      /* ── Shared button ────────────────────────── */
      button:not(.tab-btn), .btn {
        font: inherit;
        padding: 3px 8px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: var(--radius);
        cursor: pointer;
        transition: background 80ms, border-color 80ms;
        white-space: nowrap;
        line-height: 1.5;
      }
      button:not(.tab-btn):hover  { background: #222; border-color: var(--border-hi) }
      button:not(.tab-btn):active { background: #282828 }
      button:not(.tab-btn):disabled { opacity: .35; cursor: default; pointer-events: none }
      .is-active:not(.tab-btn) {
        background: var(--accent-bg) !important;
        border-color: var(--accent) !important;
        color: var(--accent) !important;
      }

      /* ── Button row ───────────────────────────── */
      .btn-row { display: flex; gap: 4px; flex-wrap: wrap }

      /* ── Script editor ────────────────────────── */
      #msc-editor-wrap {
        position: relative;
        flex: 1;
        min-height: 140px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
      }
      #msc-highlight, #msc-editor {
        position: absolute; inset: 0; margin: 0; border: 0;
        padding: 6px 8px;
        font: 12px/1.45 var(--font-mono);
        white-space: pre; overflow: auto;
      }
      #msc-highlight { pointer-events: none; color: #ddd }
      #msc-editor {
        resize: none;
        background: transparent;
        color: transparent;
        caret-color: #eee;
      }
      #msc-status {
        min-height: 14px;
        font-size: 11px;
        color: var(--text-dim);
        flex-shrink: 0;
      }

      /* ── Pixel editor controls ────────────────── */
      #pixel-controls { display: flex; flex-direction: column; gap: 4px; flex-shrink: 0 }
      .pixel-row { display: flex; align-items: center; gap: 4px; flex-wrap: wrap }
      .pixel-row input[type=number] {
        width: 48px; padding: 2px 4px;
        background: var(--bg); border: 1px solid var(--border);
        color: var(--text); border-radius: var(--radius); font: inherit;
      }
      .pixel-row input[type=color] {
        width: 22px; height: 22px; padding: 0;
        border: 1px solid var(--border); border-radius: var(--radius);
        background: none; cursor: pointer;
      }
      .pixel-row label { color: var(--text-dim); cursor: pointer; user-select: none }

      /* ── Pixel toolbox (vertical icon bar) ────── */
      #pixel-workspace {
        display: flex;
        gap: 4px;
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }
      #pixel-toolbox {
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex-shrink: 0;
      }
      .tool-btn {
        width: 26px !important;
        height: 26px !important;
        min-width: 26px !important;
        padding: 0 !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        line-height: 1;
      }
      .toolbox-sep {
        width: 18px;
        height: 1px;
        background: var(--border);
        margin: 3px auto;
      }

      /* ── Palette ──────────────────────────────── */
      #palette-swatches { display: flex; gap: 3px; flex-wrap: wrap }
      .palette-swatch {
        width: 16px; height: 16px;
        border: 1px solid var(--border); border-radius: 2px;
        cursor: pointer; transition: border-color 80ms;
        position: relative;
      }
      .palette-swatch:hover { border-color: var(--text-dim) }
      .palette-swatch.is-active { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent) }
      .palette-swatch.is-locked::after {
        content: ''; position: absolute; inset: 0;
        border: 1px solid rgba(255,255,255,.5);
        border-radius: 1px; pointer-events: none;
      }
      .palette-swatch .lock-indicator {
        position: absolute; bottom: -2px; right: -2px;
        font-size: 7px; line-height: 1; pointer-events: none;
      }
      .palette-swatch .msc-indicator {
        position: absolute; top: -2px; right: -2px;
        width: 4px; height: 4px; border-radius: 50%;
        background: var(--accent); pointer-events: none;
      }
      #palette-preset-select {
        padding: 2px 4px; font: inherit;
        background: var(--surface-2); border: 1px solid var(--border);
        color: var(--text); border-radius: var(--radius); cursor: pointer;
      }

      /* ── Toggle chips ─────────────────────────── */
      .chip-row { display: flex; gap: 3px; flex-wrap: wrap }
      .chip-row label {
        display: inline-flex; align-items: center; gap: 3px;
        padding: 2px 6px;
        background: var(--surface-2); border: 1px solid var(--border);
        border-radius: var(--radius); cursor: pointer;
        transition: background 80ms, border-color 80ms;
        user-select: none;
      }
      .chip-row label:hover { border-color: var(--border-hi) }
      .chip-row input[type=checkbox] { display: none }
      .chip-row input[type=radio] { display: none }
      .chip-row input[type=checkbox]:checked+span { color: var(--accent) }
      .chip-row input[type=radio]:checked+span { color: var(--accent) }
      .chip-row label:has(input:checked) {
        background: var(--accent-bg); border-color: var(--accent);
      }

      /* ── Pixel canvas area ────────────────────── */
      #pixel-editor-wrap {
        flex: 1;
        min-width: 0;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg);
        overflow: hidden;
        position: relative;
        touch-action: none;
      }
      #pixel-stage  { position: relative; width: 100%; height: 100%; touch-action: none }
      #pixel-editor { image-rendering: pixelated; background: transparent; border: 0 }
      #pixel-grid-overlay {
        position: absolute; inset: 0;
        pointer-events: none; image-rendering: pixelated;
      }
      #pixel-footer {
        font-size: 10px; color: var(--text-dim);
        display: flex; justify-content: space-between;
        flex-shrink: 0;
      }

      /* ── Pixel bottom bar (modern zoom & size) ── */
      #pixel-bottom-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        padding: 8px 12px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 6px;
        flex-shrink: 0;
      }
      .bar-group {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .bar-group label {
        color: var(--text-dim);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: .04em;
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
      }
      .bar-group input[type=range] {
        -webkit-appearance: none;
        appearance: none;
        width: 80px;
        height: 4px;
        background: var(--border-hi);
        border-radius: 2px;
        outline: none;
        cursor: pointer;
      }
      .bar-group input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--accent);
        border: none;
        cursor: pointer;
        transition: transform 80ms;
      }
      .bar-group input[type=range]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }
      .bar-group input[type=range]::-moz-range-thumb {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--accent);
        border: none;
        cursor: pointer;
      }
      .bar-group span {
        min-width: 24px;
        color: var(--text-dim);
        font-size: 11px;
      }
      .bar-divider {
        width: 1px;
        height: 16px;
        background: var(--border-hi);
        flex-shrink: 0;
      }

      /* ── Docs ──────────────────────────────────── */
      #docs-search {
        width: 100%; padding: 4px 6px;
        border-radius: var(--radius);
        background: var(--bg); border: 1px solid var(--border);
        color: var(--text); font: inherit;
        flex-shrink: 0;
      }
      #docs-search::placeholder { color: var(--text-dim) }
      #docs-results {
        display: flex; flex-direction: column; gap: 3px;
        max-height: 160px; overflow: auto;
        flex-shrink: 0;
      }
      .doc-item {
        text-align: left;
        background: var(--surface-2); border: 1px solid var(--border);
        color: var(--text); border-radius: var(--radius);
        padding: 4px 6px; cursor: pointer;
        transition: border-color 80ms; font: inherit;
      }
      .doc-item:hover { border-color: var(--border-hi) }
      .doc-item small { display: block; color: var(--text-dim); margin-top: 1px; font-size: 10px }
      .doc-item.is-active { border-color: var(--accent); background: var(--accent-bg) }
      #docs-content {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 6px 8px;
        background: var(--bg);
        font-size: 11px; line-height: 1.55;
        color: var(--text);
        overflow: auto; white-space: pre-wrap;
        flex: 1;
      }

      /* ── Canvas ───────────────────────────────── */
      canvas { display: block; border: 1px solid var(--border); image-rendering: pixelated }

      /* ── Syntax highlighting ──────────────────── */
      .msc-keyword { color: #56b6c2 }
      .msc-string  { color: #98c379 }
      .msc-comment { color: #6a9955 }
      .msc-symbol  { color: #e5c07b }

      /* ── Scrollbar ────────────────────────────── */
      ::-webkit-scrollbar { width: 4px; height: 4px }
      ::-webkit-scrollbar-track { background: transparent }
      ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 2px }
      ::-webkit-scrollbar-thumb:hover { background: #333 }
    </style>
  </head>
  <body>
    <div id="mozaic-app">

      <!-- ── Header ───────────────────────────────── -->
      <header id="mozaic-header">
        <div id="header-brand">
          <span id="header-logo">&#9672;</span>
          <span id="header-title">Mozaic</span>
        </div>
        <div id="header-divider"></div>
        <div id="header-actions">
          <button id="new-rom-button" type="button">&#9723; New</button>
          <button id="open-rom-button" type="button">&#9776; ROM</button>
          <button id="open-script-button" type="button">&#9998; Script</button>
          <button id="open-config-button" type="button">&#9881; Config</button>
          <div class="header-sep"></div>
          <button id="save-rom-button" type="button">&#11015; Save</button>
          <button id="reload-config-button" type="button">&#8635; Reload</button>
          <div class="header-sep"></div>
          <button id="restart-button" type="button">&#9654; Run</button>
        </div>
      </header>

      <!-- ── Workspace (split layout) ────────────── -->
      <div id="mozaic-workspace">

        <!-- LEFT: Game canvas ────────────────────── -->
        <main id="canvas-area">
          <canvas id="mozaic-canvas"></canvas>
        </main>

        <!-- SPLIT HANDLE ─────────────────────────── -->
        <div id="split-handle"></div>

        <!-- RIGHT: Tabbed side panel ─────────────── -->
        <div id="side-panel">

          <!-- Tab bar -->
          <div id="tab-bar">
            <button class="tab-btn is-active" data-tab="script" type="button">&#9998; Script</button>
            <button class="tab-btn" data-tab="pixel" type="button">&#9638; Pixel</button>
            <button class="tab-btn" data-tab="debug" type="button">&#9670; Debug</button>
            <button class="tab-btn" id="toggle-docs-button" data-tab="docs" type="button">&#9776; Docs</button>
          </div>

          <!-- Tab content -->
          <div id="tab-content">

            <!-- Tab: Script Editor ─────────────────── -->
            <section class="tab-pane is-active" id="msc-section">
              <div class="section-label" id="text-editor-title">Script Editor</div>
              <div id="msc-editor-wrap">
                <pre id="msc-highlight"></pre>
                <textarea id="msc-editor" spellcheck="false" aria-label="MSC editor"></textarea>
              </div>
              <div id="msc-status"></div>
            </section>

            <!-- Tab: Pixel Editor ──────────────────── -->
            <section class="tab-pane" id="pixel-section">
              <div id="pixel-controls">
                <div class="pixel-row">
                  <input id="pixel-color" type="color" value="#ff00ff" />
                  <button id="palette-add-button" type="button" title="Add to palette">+</button>
                  <select id="palette-preset-select" title="Palette presets">
                    <option value="">Preset...</option>
                  </select>
                  <button id="palette-import-button" type="button" title="Import palette">&#8593; Import</button>
                  <button id="palette-export-button" type="button" title="Export palette">&#8595; Export</button>
                </div>
                <div id="palette-swatches"></div>
              </div>
              <div class="chip-row">
                <label><input id="stylus-only-toggle" type="checkbox" /><span>Stylus Only</span></label>
                <label><input id="pressure-size-toggle" type="radio" name="pressure-mode" checked /><span>P:Size</span></label>
                <label><input id="pressure-dither-toggle" type="radio" name="pressure-mode" /><span>P:Dither</span></label>
              </div>
              <div id="pixel-workspace">
                <div id="pixel-toolbox">
                  <button id="preset-pencil-button" class="tool-btn" type="button" title="Pencil (B)">&#9998;</button>
                  <button id="preset-brush-button" class="tool-btn" type="button" title="Brush (3px)">&#10680;</button>
                  <button id="preset-eraser-button" class="tool-btn" type="button" title="Eraser (E)">&#9746;</button>
                  <button id="eraser-toggle-button" class="tool-btn" type="button" title="Toggle eraser (E)">&#9746;</button>
                  <button id="fill-tool-button" class="tool-btn" type="button" title="Fill (G)">&#9781;</button>
                  <button id="select-tool-button" class="tool-btn" type="button" title="Select (M)">&#11034;</button>
                  <button id="pipette-tool-button" class="tool-btn" type="button" title="Pipette (I)">&#10023;</button>
                  <div class="toolbox-sep"></div>
                  <button id="undo-button" class="tool-btn" type="button" title="Undo (Ctrl+Z)">&#8630;</button>
                  <button id="redo-button" class="tool-btn" type="button" title="Redo (Ctrl+Y)">&#8631;</button>
                  <button id="clear-button" class="tool-btn" type="button" title="Clear canvas">&#9249;</button>
                </div>
                <div id="pixel-editor-wrap">
                  <div id="pixel-stage">
                    <canvas id="pixel-editor" width="64" height="64"></canvas>
                    <canvas id="pixel-grid-overlay" width="64" height="64"></canvas>
                  </div>
                </div>
              </div>
              <div id="pixel-footer">
                <span>Alt+Click picks layer</span>
                <span id="pixel-coords">&ndash;, &ndash;</span>
              </div>
              <div id="pixel-bottom-bar">
                <div class="bar-group">
                  <label for="pixel-zoom">Zoom</label>
                  <input id="pixel-zoom" type="range" min="1" max="64" value="8" />
                  <span id="zoom-level">8&times;</span>
                </div>
                <div class="bar-divider"></div>
                <div class="bar-group">
                  <label for="brush-size">Size</label>
                  <input id="brush-size" type="range" min="1" max="9" value="1" />
                  <span id="brush-size-label">1</span>
                </div>
              </div>
            </section>

            <!-- Tab: Debug ─────────────────────────── -->
            <section class="tab-pane" id="pane-debug">
              <div class="section-label">Grid</div>
              <div class="chip-row">
                <label><input id="grid-inline-toggle" type="checkbox" checked /><span>Grid</span></label>
                <label><input id="grid-custom-toggle" type="checkbox" /><span>Custom</span></label>
              </div>
              <div class="pixel-row">
                <label for="grid-size">Cell</label>
                <input id="grid-size" type="number" min="1" max="64" value="8" />
                <label for="grid-major">Major</label>
                <input id="grid-major" type="number" min="1" max="64" value="4" />
              </div>
              <div class="section-label">Overlays</div>
              <div class="chip-row">
                <label><input id="debug-collision-toggle" type="checkbox" /><span>Collision</span></label>
                <label><input id="debug-path-toggle" type="checkbox" /><span>Paths</span></label>
                <label><input id="debug-points-toggle" type="checkbox" /><span>Pts</span></label>
                <label><input id="debug-ids-toggle" type="checkbox" /><span>IDs</span></label>
              </div>
            </section>

            <!-- Tab: Docs ──────────────────────────── -->
            <section class="tab-pane" id="docs-pane">
              <input id="docs-search" type="text" placeholder="Search..." />
              <div id="docs-results"></div>
              <div id="docs-content">Select a document.</div>
            </section>

          </div><!-- #tab-content -->
        </div><!-- #side-panel -->

      </div><!-- #mozaic-workspace -->
    </div><!-- #mozaic-app -->
    <script type="module" src="/src/index.ts"></script>
  </body>
</html>
